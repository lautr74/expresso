generator client {
  provider = "prisma-client-js"
  output    = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// --- Catálogo de Cafés ---

model Product {
  id          String    @id @default(uuid())
  name        String    @unique
  slug        String    @unique
  description String    @db.Text
  origin      String
  region      String?
  roastLevel  Roast     @default(MEDIUM)
  process     Process   @default(WASHED)
  imageUrl    String?

  subscriptions Subscription[]
  variants      Variant[]
  cartItems     CartItem[]
  orderItems    OrderItem[] 
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Variant {
  id        String   @id @default(uuid())
  weight    Int      
  price     Decimal  @db.Decimal(10, 2)
  stock     Int      @default(0)
  
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId String
  cartItems CartItem[]
  orderItems OrderItem[]
  subscriptions Subscription[]
}

// --- Planes de Suscripción ---

model Subscription {
  id        String   @id @default(uuid())
  plan      Plan   
  active    Boolean  @default(true)
  
  // Relación con el Usuario (quién paga)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  // Relación con el Producto (qué café recibe)
  productId String
  product   Product  @relation(fields: [productId], references: [id])

  // Relación con la Variante (qué tamaño/formato eligió)
  variantId String
  variant   Variant  @relation(fields: [variantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriptions")
}

// --- Usuarios ---

model User {
  id        String     @id @default(uuid())
  email     String     @unique
  password  String     // Aquí guardaremos la contraseña CIFRADA
  name      String?
  cartItems CartItem[]
  subscriptions Subscription[]
  adressess Address[]
  orders    Order[]
  createdAt DateTime   @default(now())

  @@map("users")
}

// --- Carrito de Compras ---

model CartItem {
  id        String   @id @default(uuid())
  quantity  Int      @default(1)
  
  // Relaciones
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])

  variantId String
  variant   Variant  @relation(fields: [variantId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, variantId])
  @@map("cart_items")
}

// --- Direcciones --- //

model Address {
  id           String   @id @default(uuid())
  title        String   @default("Mi Casa") // Ej: Casa, Oficina...
  street       String
  city         String
  state        String   // Provincia/Estado
  zipCode      String
  country      String   @default("España")
  isDefault    Boolean  @default(false)
  orders       Order[]
  
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@map("addresses")
}

// --- Orders --- //

model Order {
  id              String      @id @default(uuid())
  orderNumber     Int         @unique @default(autoincrement())
  status          OrderStatus @default(PENDING)
  totalAmount     Decimal     @db.Decimal(10, 2)
  
  // Relaciones
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  
  addressId       String
  address         Address     @relation(fields: [addressId], references: [id])
  
  items           OrderItem[]
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@map("orders")
}

model OrderItem {
  id        String   @id @default(uuid())
  quantity  Int
  price     Decimal  @db.Decimal(10, 2) 
  
  orderId   String
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  
  variantId String
  variant   Variant  @relation(fields: [variantId], references: [id])

  @@map("order_items")
}

// --- Enums ---

enum Roast {
  LIGHT
  MEDIUM
  DARK
}

enum Process {
  WASHED
  NATURAL
  HONEY
  BARREL_AGED
}

enum Plan {
  MENSUAL
  TRIMESTRAL
  SEMESTRAL
}

enum OrderStatus {
  PENDING
  PAID
  SHIPPED
  DELIVERED
  CANCELLED
}